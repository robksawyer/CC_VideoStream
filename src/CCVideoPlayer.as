package {		/* ****************************************************** *\	* 	CHINCHILLAX FLASH VIDEO PLAYER	* 		* 	Preview/Generator:	* 	  http://www.chinchillax.com/shop/videostream/	* 		* 	Source/Code:	* 	  https://github.com/robksawyer/CC_VideoStream	* 		* 	Problems/Issues:	* 	  https://github.com/robksawyer/CC_VideoStream/issues	* 		* 	Feature request:	* 	  https://github.com/robksawyer/CC_VideoStream/labels/feature	* 		* 	Optimized and Updated To Work With VJ Applications:	* 		Rob Sawyer	*			http://www.chinchillax.com/team	*				*		Original Author:	* 	  Martin Bommeli	* 	  http://www.flashjunior.ch	* 		* 	Original graphics and some part of codes:	* 	  Abdulhalim Kara	* 	  http://www.abdulhalimkara.com/	*	*	* 	Special thanks to:	* 	  Abdulhalim Kara (www.abdulhalimkara.com) for help, some codes and very nice skin	* 	  Florian Weil (www.derhess.de) for his youtube classes	* 	  DIVIO (www.divio.ch) for given time	*	\* ****************************************************** */		import flash.net.SharedObject;	import flash.system.Security;		import flash.display.MovieClip;	import flash.events.Event;	import flash.events.MouseEvent;	import flash.external.ExternalInterface;	import com.vimeo.api.VimeoPlayer;			import com.gskinner.utils.StringUtils;		import com.fj.utils.StopDragButton;	import com.fj.video.VideoPlayer;	import flash.utils.Timer;	import flash.events.TimerEvent;		import com.demonsters.debugger.MonsterDebugger;	//import the Resolume communication classes	//make sure you have added the source path to these files in the ActionScript 3 Preferences of Flash	import resolumeCom.*;	import resolumeCom.parameters.*;	import resolumeCom.events.*;	//Chinchillax classes	//	import com.chinchillax.events.SoftwareDispatcher;	public class CCVideoPlayer extends MovieClip{		/*****************PRIVATE********************/		//create the resolume object that will do all the hard work for you		private var resolume:Resolume = new Resolume();				private var resDispatcher:SoftwareDispatcher = new SoftwareDispatcher();		/*****************RESOLUME PARAMS********************/				private var paramVideoSource:StringParameter = resolume.addStringParameter("Video Source", "https://vimeo.com/126091504");		private var paramAutoPlay:BooleanParameter = resolume.addBooleanParameter("Auto Play", true); 		private var paramMute:BooleanParameter = resolume.addBooleanParameter("Mute", true); 		private var paramHideControls:BooleanParameter = resolume.addBooleanParameter("Hide Ctrls", false); 		private var paramVideoLoop:BooleanParameter = resolume.addBooleanParameter("Video Loop", true); 				private var trimInPoint:FloatParameter = resolume.addFloatParameter("Set In Point", 0.0);		private var trimOutPoint:FloatParameter = resolume.addFloatParameter("Set Out Point", 1.0);		private var theScrubber:FloatParameter = resolume.addFloatParameter("Scrub", 0.0);				private var thePause:EventParameter = resolume.addEventParameter("Play/Pause");		private var paramSwitchVideo:EventParameter = resolume.addEventParameter("Update Video"); //A button to update the video				private var theVolume:FloatParameter = resolume.addFloatParameter("Volume", 0);				/*****************END RESOLUME PARAMS********************/				private var VideoMovie:*;		//https://developer.vimeo.com/apps/53664#authentication		private var vimeo_oauth_key:String = 'f56cfac6c1fba5567852f24e6a9e2937dc05fcdf'; 		private var videoPaused:Boolean = false;		private var sharedObj : SharedObject;		private var paramClickCounter:int = 0;		/*****************PUBLIC********************/				public static var videoSrc : String;		public static var imgSrc : String;				public static var fullscreenMode : String;		public static var videoLoop : String;		public static var autohide : String;		public static var autoplay : String;		public static var mute : String;		public static var seekbarColor:String;		public static var seekbarbgColor:String;		public static var loadingbarColor:String;		public static var textColor:String;				public static var btnOutColor:String;		public static var btnOverColor:String;		public static var btnHighlightColor:String;		public var playheadTimer:Timer;				private var vimeoCheck:Boolean = false;		private var youtubeCheck:Boolean = false;		/**		*		* Constructor		*		**/		public function CCVideoPlayer(){			//set callback, this will notify us when a parameter has changed			resolume.addParameterListener(parameterChanged);						Security.allowDomain("www.youtube.com");			Security.allowDomain("s.ytimg.com");						if(loaderInfo.bytesLoaded >= loaderInfo.bytesTotal){				init();			}else{				loaderInfo.addEventListener(Event.COMPLETE, init, false, 0, true);			}			//			//Custom event that was added to handle a VJ app change of the video source			//Fired when the user presses the "Update Video" button in the app.			//			resDispatcher.addEventListener(SoftwareDispatcher.UPDATE_VIDEO, updateVideo);		}				/**		*		* The video player setup		* @param e:Event		* @return void		**/		private function init(e:Event = null):void{			Security.allowDomain("*");						// Start the MonsterDebugger			MonsterDebugger.initialize(this);			MonsterDebugger.enabled = false;			MonsterDebugger.clear();						MonsterDebugger.trace(this, "CCVideoPlayer - init");						sharedObj = SharedObject.getLocal("osvideoplayervolumelevel");			loaderInfo.removeEventListener(Event.COMPLETE, init);			addEventListener(Event.ADDED_TO_STAGE, initPlayer);		}				/**		*		* The initialize method for the video player functions/elements.		* @param e:Event 		* @return void		*		**/		private function initPlayer(e:Event):void{			removeEventListener(Event.ADDED_TO_STAGE, initPlayer);				stage.scaleMode = flash.display.StageScaleMode.SHOW_ALL;			stage.align = flash.display.StageAlign.TOP_LEFT;						VideoPlayer.STAGE = StopDragButton.STAGE = stage;						imgSrc 						= stage.loaderInfo.parameters["image"];			videoSrc 					= stage.loaderInfo.parameters["movie"];			videoLoop 				= stage.loaderInfo.parameters["loop"];			fullscreenMode 		= stage.loaderInfo.parameters["fullscreen"];			mute 							= stage.loaderInfo.parameters["mute"];			autohide 					= stage.loaderInfo.parameters["autohide"];			autoplay 					= stage.loaderInfo.parameters["autoplay"];			seekbarColor 			= stage.loaderInfo.parameters["color_seekbar"];			seekbarbgColor 		= stage.loaderInfo.parameters["color_seekbarbg"];			loadingbarColor 	= stage.loaderInfo.parameters["color_loadingbar"];			textColor 				= stage.loaderInfo.parameters["color_text"];			btnOutColor 			= stage.loaderInfo.parameters["color_button_out"];			btnOverColor 			= stage.loaderInfo.parameters["color_button_over"];			btnHighlightColor = stage.loaderInfo.parameters["color_button_highlight"];						//!videoSrc ? videoSrc = "http://www.flashjunior.ch/archiv/flvplayer/movies/kuga.mp4" : videoSrc = videoSrc;			//TEST flv 			!videoSrc ? videoSrc = "http://www.flashjunior.ch/archiv/flvplayer/movies/sad.flv" : videoSrc = videoSrc;			//TEST youtube 1 	!videoSrc ? videoSrc = "http://www.youtube.com/watch?v=YFa59lK-kpo" : videoSrc = videoSrc;			//TEST youtube 2 				videoSrc = this.paramVideoSource.getValue().toString();			//TEST youtube 3 	!videoSrc ? videoSrc = "http://www.youtube.com/v/XrPNl_gZlvYYYYYY" : videoSrc = videoSrc;			//TEST vimeo 1 		!videoSrc ? videoSrc = "http://vimeo.com/7917744" : videoSrc = videoSrc;			//TEST vimeo 2		!videoSrc ? videoSrc = "http://www.vimeo.com/3740633" : videoSrc = videoSrc;						!imgSrc ? imgSrc = "" : imgSrc = imgSrc;			//TEST				!imgSrc ? imgSrc = "http://www.flashjunior.ch/archiv/flvplayer/2/vorschau.jpg" : imgSrc = imgSrc;									!autohide ? autohide = paramHideControls.getValue().toString() : autohide = autohide;			!mute ? mute = paramMute.getValue().toString() : mute = mute;			!autoplay ? autoplay = paramAutoPlay.getValue().toString() : autoplay = autoplay;			!videoLoop ? videoLoop = paramVideoLoop.getValue().toString() : videoLoop = videoLoop;						!fullscreenMode ? fullscreenMode = "false" : fullscreenMode = fullscreenMode;						!seekbarColor ? seekbarColor = "0xf6f6f6" : seekbarColor = seekbarColor;			!seekbarbgColor ? seekbarbgColor = "0x231f20" : seekbarbgColor = seekbarbgColor;			!loadingbarColor ? loadingbarColor = "0xe1e1e1" : loadingbarColor = loadingbarColor;			!textColor ? textColor = "0xffffff" : textColor = textColor;			!btnOutColor ? btnOutColor = "0x6d6d6d" : btnOutColor = btnOutColor;			!btnOverColor ? btnOverColor = "0x000000" : btnOverColor = btnOverColor;			!btnHighlightColor ? btnHighlightColor = "0x6d6d6d" : btnHighlightColor = btnHighlightColor;			if(autoplay)			{				videoPaused = false;			}			else			{				videoPaused = true;			}			//			//Figure out what type of video was added			//			parseVideoSourceAndBuildPlayer(videoSrc);			//start playhead timer to check the playhead position			playheadTimer = new Timer(100);			playheadTimer.addEventListener(TimerEvent.TIMER, checkPlayHead);			playheadTimer.start();			if(ExternalInterface.available) ExternalInterface.addCallback("getVideoTimeData", getTimeData);			if(ExternalInterface.available) ExternalInterface.call("onVideoPlayerInited");		}		/**		*		* Parses the video source string and adds a player to the stage		* @param videoSrc:String		* @return void		*		**/		private function parseVideoSourceAndBuildPlayer(videoSrc:String):void		{			var regex:RegExp;			var regexResult:*;						if(StringUtils.contains(videoSrc, "youtube.com"))			{				regex = RegExp("http://www.youtube.com/v/(.+?)(\&.*|$)");				regexResult = regex.exec(videoSrc);				youtubeCheck = false;								if(regexResult)				{					videoSrc = regexResult[1].toString();					youtubeCheck = true;				}				else				{					regex = /youtube\.com\/watch\?v=([^&\/]+)/;					regexResult = regex.exec(videoSrc);					if(regexResult)					{						videoSrc = regexResult[1].toString();						youtubeCheck = true;					}				}								VideoMovie = new VideoPlayer(videoSrc, "youtube");							} 			else if(StringUtils.contains(videoSrc, "vimeo.com"))			{				regex = RegExp("vimeo.com/(.+?)(\&.*|$)");				regexResult = regex.exec(videoSrc);				vimeoCheck = false;				if(regexResult)				{					videoSrc = regexResult[1].toString();					vimeoCheck = true;				}								if(fullscreenMode == "true")				{					fullscreenMode = "1";				}				else				{					fullscreenMode = "0";				}				VideoMovie = new VimeoPlayer(vimeo_oauth_key, int(videoSrc), stage.stageWidth, stage.stageHeight); //Number(fullscreenMode));				VideoMovie.addEventListener(Event.COMPLETE, handleVimeoPlayerReady);			} 			else			{				VideoMovie = new VideoPlayer(videoSrc, "normal");			}			//Add the player to the stage			addChild(VideoMovie);			if(mute == true || mute == "true")			{				MonsterDebugger.trace(this, "Muting the video.", "Mute");				if(!vimeoCheck)				{					VideoMovie.volume = 0;				}				else				{					//VideoMovie.setVolume(0);				}							}		}		/**		*		* Resets the player after the Update Video button is pressed inside the VJ app		* @param e:Event 		* @return void		*		**/		public function updateVideo():void		{			MonsterDebugger.trace(this, "updateVideo()", "Reset");			if(VideoMovie)			{				//VideoMovie.resetVideo(videoSrc);				MonsterDebugger.trace(this, VideoMovie, "Reset");				removeChild(VideoMovie);				playheadTimer.stop();				parseVideoSourceAndBuildPlayer(videoSrc);				playheadTimer.start();				MonsterDebugger.trace(this, "Creating a new VideoMovie instance.", "Reset");			}			else			{				MonsterDebugger.trace(this, "There was an issue finding the previous VideoMovie instance.", "ERROR");			}		}		/**		*		* Called everytime you change a paramater in Resolume.		* @param event:ChangeEvent		* @return void		* 		**/		public function parameterChanged( event:ChangeEvent ): void {			//check to see what paramater was changed			switch(event.object)			{				case this.paramVideoSource:					videoSrc = this.paramVideoSource.getValue();					break;				case this.paramVideoLoop:					videoLoop = this.paramVideoSource.getValue();					break;				case this.paramAutoPlay:					autoplay = this.paramAutoPlay.getValue() == 1 ? "true" : "false";					break;				case this.paramMute:					mute = this.paramMute.getValue() == 1 ? "true" : "false";					if(VideoMovie != undefined)					{						VideoMovie.toggleMute();					}					break;				case this.paramHideControls:					autohide = this.paramHideControls.getValue() == 1 ? "true" : "false";					if(VideoMovie != undefined)					{						//Reinitialize the movie						VideoMovie.initializeAutoHide();					}					break;										case this.paramSwitchVideo:					if(paramClickCounter == 0){						paramClickCounter++;					}					else 					{						MonsterDebugger.trace(this, "Switching video!", "Param");						//Using the custom dispatcher, eventually dispatches an event 						//that fires initPlayer						updateVideo();						paramClickCounter = 0;					}					break;									case this.trimInPoint:					if(paramClickCounter == 0){						paramClickCounter++;					}					else 					{						if(VideoMovie != undefined && !vimeoCheck)						{							playheadTimer.stop();							VideoMovie.trimInPoint = this.trimInPoint.getValue();							MonsterDebugger.trace(this, "Param trim in point: " + this.trimInPoint.getValue(), "Param");							MonsterDebugger.trace(this, "Converted trim in point: " + VideoMovie.trimInPoint, "Trim");							VideoMovie.updateTrimHandleLocations();							VideoMovie.hardSeekVideo(VideoMovie.trimInTime, true);							playheadTimer.start();						}						paramClickCounter = 0;					}					break;										case this.trimOutPoint:					if(paramClickCounter == 0){						paramClickCounter++;					}					else 					{						if(VideoMovie != undefined && !vimeoCheck)						{							playheadTimer.stop();							VideoMovie.trimOutPoint = this.trimOutPoint.getValue();							MonsterDebugger.trace(this, "Param trim out point: " + this.trimOutPoint.getValue(), "Param");							MonsterDebugger.trace(this, "Converted trim out point: " + VideoMovie.trimOutPoint, "Trim");							VideoMovie.updateTrimHandleLocations();							VideoMovie.hardSeekVideo(VideoMovie.trimInTime, true);							playheadTimer.start();						}						paramClickCounter = 0;					}					break;									case this.theScrubber:					if(VideoMovie != undefined)					{						VideoMovie.scrubPoint = this.theScrubber.getValue();					}					break;				case this.thePause:					if(paramClickCounter == 0){						paramClickCounter++;					}					else					{						if(VideoMovie != undefined)						{							MonsterDebugger.trace(this, "Video Paused: " + videoPaused, "Param");							if(!videoPaused)							{								//VideoMovie.pauseVideo();								VideoMovie.PAUSE_BTN.dispatchEvent(new MouseEvent(MouseEvent.CLICK));								videoPaused = true;								//Pause the playhead timer								MonsterDebugger.trace(this, "playheadTimer Pausing", "Param");								if(playheadTimer)								{									playheadTimer.stop();								}							}							else							{								//VideoMovie.playVideo();								VideoMovie.PLAY_BTN.dispatchEvent(new MouseEvent(MouseEvent.CLICK));								videoPaused = false;								MonsterDebugger.trace(this, "playheadTimer Playing", "Param");								if(playheadTimer)								{									playheadTimer.start();								}							}						}						paramClickCounter = 0;					}					break;									case this.theVolume:					if(VideoMovie != undefined)					{												if(!vimeoCheck)						{							VideoMovie.volume = this.theVolume.getValue();						}						else						{							VideoMovie.setVolume(this.theVolume.getValue());						}						MonsterDebugger.trace(this, "Updated Volume: " + VideoMovie.volume, "Param");					}					break;								default:					MonsterDebugger.trace(this, event.object);					break;			}				}				/**		*		* Handles when the READY event of the Vimeo player		* @param e:Event		* @return void		* 		**/		private function handleVimeoPlayerReady(e:Event):void		{			MonsterDebugger.trace(this, "Vimeo Player Ready");			if(autoplay == "true")			{ 				VideoMovie.play(); 			}			if(mute == true || mute == "true")			{				VideoMovie.setVolume(0);			}									//VideoMovie.changeColor(seekbarColor.substr(2));						/*var p_n:Number;			if(videoLoop=="false"){				p_n = 0;			}else{				p_n = 1;			}*/						/*if(sharedObj.data.volume == undefined){				if(mute == true || mute == "true")				{					sharedObj.data.volume = 0;				}				else				{					sharedObj.data.volume = 100;				}			}*/						//DEPRECATED: These no longer exist			//VideoMovie.setLoop(p_n);			//VideoMovie.setVolume(Number(sharedObj.data.volume));					}		/**		* Check to see if the video is at the "end"		* if so, go to in-point		* @param e:TimerEvent		* @return void		*/		private function checkPlayHead(e:TimerEvent):void		{			if(!vimeoCheck && VideoMovie.trimOutPoint != undefined && VideoMovie.trimInPoint != undefined)			{				var thePlayheadTime = VideoMovie.time; //video_mc.getCurrentTime();				var theTrimInPointTime = VideoMovie.trimInTime;				var theTrimOutPointTime = VideoMovie.trimOutTime;				MonsterDebugger.trace(this, "Playhead time: " + thePlayheadTime, "Playhead");				MonsterDebugger.trace(this, "Trim in time: " + theTrimInPointTime, "Playhead");				MonsterDebugger.trace(this, "Trim out time: " + theTrimOutPointTime, "Playhead");				if(thePlayheadTime != undefined && thePlayheadTime >= theTrimOutPointTime)				{					MonsterDebugger.trace(this, "Restarting Video (from Trim In)", "Playhead");					//TODO: This is getting called multiple times and it shouldn't be.					//thePlayheadTime = 0;					VideoMovie.hardSeekVideo(theTrimInPointTime, true);				}			}		}				/**		*		* Returns the video time data as an object		* @param void		* @return String		**/		public function getTimeData():Object		{		    return {"duration":VideoMovie.duration, "currentTime":VideoMovie.time, "playing": VideoMovie.currentState == "playing"};		}		/**		*		* Rounds to a specific number of decimal places		* @param num:Number The number to round		* @param places:Number The number of decimal places to round to		* @return Number Rounded number		**/		public function roundTo(num:Number, places:Number = 0):Number		{			if(places == 1)			{				return int((num)*10)/10;			}			else if(places == 2)			{				return int((num)*100)/100;			}			else if(places == 3)			{				return int((num)*1000)/1000;			}			else if(places == 4)			{				return int((num)*10000)/10000;			}			else			{				return Math.round(num);			}		} 	}}